<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Serol's Network Overview</title>
  <meta name="description" content="Serol's Network Overview">
  <meta name="author" content="Edward Gomez">

  <link rel="stylesheet" href="css/styles.css?v=1.8.1">
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script type="module" src="js/suncalc.js"></script>
  <script src="js/lottie.js"></script>


</head>

<body>
  <div id="sites">
    <h2>Updated {{ updated }}</h2>
    <div id="serol-status" class="status"></div>
    <div v-for="(value, name) in sitecodes" :class="'site ' +name">
        <h1>{{ name }}</h1>
        <div v-for="tel in value.tels" class="telescope">
         <div :id="tel.name" class="status" :title="tel.state"></div>
        </div>
    </div>
</div>

<script>
  // import suncalc from '@/suncalc';
  var display_

  var app = new Vue({
  el: '#sites',
  props: ['site', 'sitestatus'],
  data: {
    siteList: {"coj.clma.0m4a":[{"telescope":"coj.clma.0m4a","event_type":"AVAILABLE","event_reason":"Available for scheduling","start":"2019-10-04T13:26:17Z","end":"2019-10-04T13:26:17Z"}],"coj.clma.0m4b":[{"telescope":"coj.clma.0m4b","event_type":"AVAILABLE","event_reason":"Available for scheduling","start":"2019-10-04T13:26:17Z","end":"2019-10-04T13:26:17Z"}]},
    sitecodes: {'coj':{'weather':{'current':'NOT_OK_TO_OPEN'},'tels':[{'name':'coj.clma.0m4a','state':'UNKNOWN'},{'name':'coj.clma.0m4b','state':'UNKNOWN'},{'name':'coj.clma.2m0a','state':'UNKNOWN'},{'name':'coj.doma.1m0a','state':'UNKNOWN'},{'name':'coj.domb.1m0a','state':'UNKNOWN'}]},
                'cpt' :{'weather':{'current':'NOT_OK_TO_OPEN'},'tels':[{'name':'cpt.doma.1m0a','state':'UNKNOWN'},{'name':'cpt.domb.1m0a','state':'UNKNOWN'},{'name':'cpt.domc.1m0a','state':'UNKNOWN'},{'name':'cpt.aqwa.0m4a','state':'UNKNOWN'}]},
                'elp' :{'weather':{'current':'NOT_OK_TO_OPEN'},'tels': [{'name':"elp.aqwa.0m4a",'state':'UNKNOWN'},{ 'name':"elp.doma.1m0a",'state':'UNKNOWN'}]},
                'lsc':{'weather':{'current':'NOT_OK_TO_OPEN'},'tels':[{'name':'lsc.doma.1m0a','state':'UNKNOWN'},{'name':'lsc.domb.1m0a','state':'UNKNOWN'},{'name':'lsc.domc.1m0a','state':'UNKNOWN'},{'name':'lsc.aqwa.0m4a','state':'UNKNOWN'},{'name':'lsc.aqwa.0m4b','state':'UNKNOWN'}]},
                'ogg':{'weather':{'current':'NOT_OK_TO_OPEN'},'tels':[{'name':'ogg.clma.0m4a','state':'UNKNOWN'},{'name':'ogg.clma.0m4b','state':'UNKNOWN'},{'name':'ogg.clma.2m0a','state':'UNKNOWN'}]},
                'tfn':{'weather':{'current':'NOT_OK_TO_OPEN'},'tels':[{'name':"tfn.aqwa.0m4a",'state':'UNKNOWN'},{'name':"tfn.aqwa.0m4b",'state':'UNKNOWN'}]},
                'tlv':{'weather':{'current':'NOT_OK_TO_OPEN'},'tels':[{'name':"tlv.doma.1m0a",'state':'UNKNOWN'}]}
              },
    updated: null,
    timer: undefined
  },
  // computed: {
  //   isNight(){
  //       const position = suncalc.getPosition(moment.utc().valueOf(), this.site.lat, this.site.lng);
  //       return position.altitude < 0;
  //   },
  // },
    created () {
        this.loadData();
        this.timer = setInterval(this.loadData, 300000)
    },
    beforeDestroy() {
      if (this.timer) {
        clearInterval(this.timer)
        this.timer = undefined
      }
    },
    methods: {
      loadData: function() {
      axios.get('https://observe.lco.global/api/telescope_states/?format=json')
        .then(response => response.data)
        .then(json => {
          this.updated = Date();
          var tmparr = this.sitecodes;
          var instate;
          var anims = lottie.getRegisteredAnimations()
          anims.forEach(function(a){a.destroy()})
          addAnimation('serol-status','serol-thinking',true);
          for (var s in this.sitecodes){
            this.sitecodes[s]['tels'].forEach(function(el, i){
              if (json[el.name] != undefined){
                instate = json[el.name][0]['event_type'];
                tmparr[s]['tels'][i].state = instate;
                tmptime = json[el.name][0]['start'];
                addAnimation(el.name, instate);
                console.log(el.name, instate);
              } else {
                addAnimation(el.name,'UNKNOWN');
              }
            })
          }
        })
      },
      loadWeather: function(){
        for (var s in this.sitecodes){
        axios.get('https://weather-api.lco.global/query?site='+s+'&datumname=Weather%20Ok%20To%20Open&agg=False&start=2019-10-09T17:00:00Z&end=2019-10-10T17:12:00Z')
          .then(response => response.data)
          .then(json => {

          });
        }
      },
      cancelAutoUpdate () {
        clearInterval(this.timer)
      }
  },

})

function addAnimation(id, state, serol=false){

  var size = id.substr(9,3);
  var statusfile;
  var statefile = {
    'AVAILABLE' : 'active.json?v=1.3',
    'NOT_OK_TO_OPEN': 'angry.json?v=1.3',
    'ENCLOSURE_INTERLOCK': 'sick.json?v=1.3',
    'UNKNOWN': 'sleep.json?v=1.3',
    'SEQUENCER_DISABLED' : 'sleep.json?v=1.3',
    'SITE_AGENT_UNRESPONSIVE' : 'sleep.json?v=1.3',
    'serol-thinking':'serol.json?v=1.4'
  }
  if (serol == true){
    statusfile = '/js/'+statefile[state];
  } else {
    statusfile = "/js/"+size+"/"+statefile[state];
  }
  console.log(id)
  // anims
  lottie.loadAnimation({
      animationID: id,
      container: document.getElementById(id),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      autoloadSegments: true,
      rendererSettings: {
          progressiveLoad:false
      },
      path: statusfile
  });
}

</script>
</body>
</html>
