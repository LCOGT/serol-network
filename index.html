<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Serol's Network Overview</title>
  <meta name="description" content="Serol's Network Overview">
  <meta name="author" content="Edward Gomez">

  <link rel="stylesheet" href="css/styles.css?v=1.8.10">
  <link rel="stylesheet" href="css/grid.css?v=0.3.2">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.5.9/lottie.min.js"></script>
  <script src="https://kit.fontawesome.com/a6b928a86b.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script type="module" src="js/suncalc.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" type="text/javascript"></script>
  <script src="js/terminator.js?v=0.2.3"></script>
  <script>
	var map;
	window.onload = function() {
		// Add location placemarks
		var placemarks = new Array();
		placemarks.push({lon:-156.26,lat:20.71,label:'Haleakala',link:'https://lco.global/observatory/sites/haleakala',id:'ogg'});
		placemarks.push({lon:149.06,lat:-31.27,label:'Siding\nSpring',link:'https://lco.global/observatory/sites/siding-spring',align:"left",id:'coj'});
		placemarks.push({lon:-16.51,lat:28.13,label:"Teide",link:'https://lco.global/observatory/sites/teide',align:"left", id:'tfn'});
		placemarks.push({lon:-70.81,lat:-30.17,label:"Cerro Tololo",link:'https://lco.global/observatory/sites/cerro-tololo',id:'lsc'});
		placemarks.push({lon:20.81,lat:-32.38,label:"Sutherland",link:'https://lco.global/observatory/sites/sutherland',id:'cpt'});
		placemarks.push({lon:-104.01,lat:30.68,label:"McDonald",link:'https://lco.global/observatory/sites/mcdonald',id:'elp'});
		placemarks.push({lon:30.595833,lat:34.763333,label:"Wise",link:'https:/lco.global/observatory/sites/wise',id:'tlv'});
		//placemarks.push({lon:-120.038889,lat:34.6875,label:'Sedgwick',link:'http://lcogt.net/site/sedgwick',align:"left"});

		map = new WorldMap({placemarks:placemarks,container:'body'});
		setInterval("map.update()",60000);	// Update every minute
	}
	</script>

</head>

<body>
  <div id="sites" class="wrapper">
      <div class="header">
        <h2>Updated {{ updated }}</h2>
      </div>

      <div id="map" class="worldMap">
        	<img id="night" src="imgs/map1-night-01.jpg" style="display:none;" />
        	<img id="day" src="imgs/map1-day-01.jpg" style="display:none;" />
      </div>
    <div v-for="(value, name) in sitecodes" :class="'site ' +name" >
        <div class="site-info">
        <div class="title">{{ value.name }}</div>
        <p class="title" v-if="value.weather.day">
          <span v-if="value.weather.current"><i class="fas fa-sun"></i></span>
          <span v-else><i class="fad fa-clouds-sun"></i></span>
        <p  class="title" v-else>
          <span v-if="value.weather.current"><i class="fas fa-stars"></i></span>
          <span v-else><i class="fad fa-clouds-moon"></i></span>
        </p>
        <div class="telescopes">
          <div v-for="tel in value.tels" class="telescope">
           <div :id="tel.name" class="status" :title="tel.state"></div>
          </div>
        </div>
      </div>
    </div>
</div>

<script>
  var display_

  var app = new Vue({
  el: '#sites',
  props: ['sites', 'sitestatus'],
  data: {
    sitecodes: {},
    updated: null,
    timer: undefined
  },
  computed: {

  },
  created: async function () {
    var self = this;
      this.getJsonData();
      await this.siteCheck();
      this.timer = setInterval(function(){
          Promise.all([self.siteCheck()])
        },10000);
  },
    beforeDestroy() {
      if (this.timer) {
        clearInterval(this.timer)
        this.timer = undefined
      }
    },
    methods: {
      siteCheck: async function(){
        await this.weather();
        await this.loadData();
        this.setAnimations();
      },
      loadData: async function() {
        console.log('site status');
        try {
            let response = await axios.get('https://observe.lco.global/api/telescope_states/?format=json')
            json = response.data;
            this.updated = Date();
            var tmparr = this.sitecodes;
            var instate;
            for (var s in this.sitecodes){
              var day = this.sitecodes[s]['weather']['day'];
              this.sitecodes[s]['tels'].forEach(function(el, i){
                if (json[el.name] != undefined){
                  if (day){
                    instate = 'DAY';
                  }else{
                    instate = json[el.name][0]['event_type'];
                  }
                  tmparr[s]['tels'][i].state = instate;
                  tmptime = json[el.name][0]['start'];
                  console.log(el.name, instate);
                }
              })
            }
          } catch(error) {
            console.log(error);
          }
      },
      setAnimations() {
        // addAnimation('serol-status','serol-thinking',true);
          for (var s in this.sitecodes){
            this.sitecodes[s]['tels'].forEach(function(el, i){
                addAnimation(el.name, el.state);
                console.log(el.name, el.state);
            })
          }
        // lottie.destroy('serol-status')
      },
      getJsonData () {
        fetch( 'js/sites.js?v1=1.1' ).then( resp => resp.json() ).then( json => { this.sitecodes = json; });
      },
      cancelAutoUpdate () {
        clearInterval(this.timer)
      },
      weather: async function() {
        var now = new Date();
        var end = now.toISOString();
        now.setDate(now.getDate()-1);
        var start = now.toISOString();
        for (var site in this.sitecodes){
          var position = SunCalc.getPosition(now, this.sitecodes[site]['lat'], this.sitecodes[site]['lng']);
          this.sitecodes[site]['weather']['day'] = (position.altitude < 0) ? false : true;
          this.sitecodes[site]['weather']['current'] = await this.checkWeather(site, start, end);
          console.log(this.sitecodes[site]['weather']['current']);
        }
        console.log('weather done')
      },
      checkWeather: async function(site,start,end) {
        return await axios.get('https://weather-api.lco.global/query?site='+site+'&datumname=Weather%20Ok%20To%20Open&agg=False&start='+start+'&end='+end)
          .then(response => response.data)
          .then(json => json[json.length-1]['ValueString']=='true' ? true : false);
      }
    }
});


function addAnimation(id, state, serol=false){

  var size = id.substr(9,3);
  var statusfile;
  var statefile = {
    'AVAILABLE' : 'active.json?v=1.3',
    'NOT_OK_TO_OPEN': 'angry.json?v=1.5.1',
    'ENCLOSURE_INTERLOCK': 'sick.json?v=1.3',
    'UNKNOWN': 'sleep.json?v=1.3',
    'SEQUENCER_DISABLED' : 'sleep.json?v=1.3',
    'SITE_AGENT_UNRESPONSIVE' : 'sleep.json?v=1.3',
    'DAY' : 'sleep.json?v=1.3',
    'serol-thinking':'serol.json?v=1.4'
  }
  if (serol == true){
    statusfile = '/js/'+statefile[state];
  } else {
    statusfile = "/js/"+size+"/"+statefile[state];
  }
  // anims
  console.log("Setting status " +id);
  lottie.destroy(id);
  lottie.loadAnimation({
      name : id,
      animationID: id,
      container: document.getElementById(id),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      autoloadSegments: true,
      rendererSettings: {
          progressiveLoad:false
      },
      path: statusfile
  });
  console.log("Set "+id)
}

</script>
</body>
</html>
